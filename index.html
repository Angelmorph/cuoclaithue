<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#0d1b2a">
    <title>Ứng dụng Tìm Đường & Tính Cước</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <style>
        /* CSS styles for the application */
        *{margin:0;padding:0;box-sizing:border-box;font-family:'Segoe UI',Tahoma,Geneva,Verdana,sans-serif;-webkit-tap-highlight-color:transparent;}
        body{background:linear-gradient(135deg,#0a1929,#0d1b2a);min-height:100vh;padding:10px;color:#e0e1dd;overflow-x:hidden;font-size:90%;touch-action:manipulation;}
        .container{width:98%;max-width:1400px;min-height:95vh;margin:10px auto;background:linear-gradient(145deg,#1b263b,#0d1b2a);border-radius:15px;box-shadow:0 10px 30px rgba(0,0,0,0.5);overflow:visible;display:grid;grid-template-rows:1fr auto;border:1px solid #415a77;padding:15px;}
        .main-content{display:grid;grid-template-columns:1fr;gap:15px;height:100%;min-height:0;}
        .map-panel{display:flex;flex-direction:column;gap:10px;min-height:400px;}
        #map-container{flex:1;border-radius:12px;overflow:hidden;box-shadow:0 5px 15px rgba(0,0,0,0.3);background:rgba(13,27,42,0.5);position:relative;border:1px solid #415a77;min-height:300px;}
        .map-overlay{position:absolute;bottom:10px;left:10px;background:rgba(13,27,42,0.9);padding:8px 12px;border-radius:8px;z-index:1000;font-weight:bold;box-shadow:0 3px 10px rgba(0,0,0,0.3);font-size:0.8rem;color:#e0e1dd;border:1px solid #415a77;}
        .action-panel{display:flex;justify-content:center;margin-top:5px;gap:10px;}
        .action-btn{background:linear-gradient(135deg,#4cc9f0,#4361ee);color:white;border:none;padding:12px 20px;font-size:1rem;border-radius:10px;cursor:pointer;display:flex;align-items:center;justify-content:center;gap:8px;font-weight:bold;width:100%;touch-action:manipulation;transition:all 0.3s ease;}
        .action-btn:hover{transform:translateY(-2px);box-shadow:0 5px 15px rgba(76,201,240,0.4);}
        #clear-route-btn{background:linear-gradient(135deg,#f72585,#b5179e);max-width:150px;}
        .app-info{background:rgba(27,58,94,0.5);border-radius:10px;padding:12px;margin:8px 0;border-left:4px solid #4cc9f0;position:relative;z-index:2;display:flex;flex-direction:column;}
        .app-info-header{display:flex;justify-content:space-between;align-items:center;cursor:pointer;}
        .app-info h3{color:#4cc9f0;display:flex;align-items:center;gap:6px;font-size:1rem;}
        .app-info-content{margin-top:8px;font-size:0.85rem;line-height:1.4;max-height:0;overflow:hidden;transition:max-height 0.3s ease;}
        .app-info.expanded .app-info-content{max-height:200px;}
        .input-section{display:flex;flex-direction:column;gap:12px;overflow:visible;min-height:0;}
        .input-panel{background:rgba(13,27,42,0.7);border-radius:10px;padding:15px;box-shadow:0 5px 15px rgba(0,0,0,0.3);border:1px solid #415a77;transition:transform 0.3s ease;}
        .input-panel:hover{transform:translateY(-3px);}
        .input-panel h2{color:#778da9;margin-bottom:15px;display:flex;align-items:center;gap:8px;font-size:1.1rem;}
        .input-panel h2 i{color:#4cc9f0;font-size:1rem;}
        .input-group{position:relative;margin-bottom:10px;}
        input[type="text"]{width:100%;padding:12px 12px 12px 36px;font-size:0.9rem;border:2px solid #415a77;border-radius:8px;background:rgba(13,27,42,0.8);color:#e0e1dd;touch-action:manipulation;transition:border-color 0.3s;}
        input[type="text"]:focus{border-color:#4cc9f0;outline:none;box-shadow:0 0 0 2px rgba(76,201,240,0.3);}
        .input-icon{position:absolute;left:12px;top:50%;transform:translateY(-50%);color:#778da9;font-size:1rem;}
        .suggestions-list{border:2px solid #415a77;border-radius:8px;max-height:200px;overflow-y:auto;list-style:none;padding:0;margin:8px 0 0 0;background:rgba(13,27,42,0.95);box-shadow:0 5px 15px rgba(0,0,0,0.3);display:none;z-index:1000;position:absolute;width:100%;}
        .suggestions-list li{padding:10px 12px;border-bottom:1px solid #415a77;cursor:pointer;font-size:0.85rem;display:flex;align-items:center;gap:8px;color:#e0e1dd;transition:background-color 0.2s;}
        .suggestions-list li:hover{background-color:#415a77;}
        .address-details{display:block;font-size:0.75rem;color:#a0d2ff;margin-top:4px;}
        .selected-location{margin-top:12px;padding:12px;border-radius:8px;background:rgba(27,58,94,0.5);border-left:4px solid #4cc9f0;font-size:0.85rem;display:flex;align-items:center;gap:8px;}
        .clear-btn{margin-left:auto;background:none;border:none;color:#f72585;cursor:pointer;font-size:0.9rem;transition:transform 0.2s;}
        .clear-btn:hover{transform:scale(1.1);}
        .location-buttons{display:flex;gap:10px;margin-top:12px;}
        .locate-btn{background:linear-gradient(135deg,#4361ee,#3a0ca3);color:white;border:none;padding:8px 12px;border-radius:8px;cursor:pointer;display:flex;align-items:center;justify-content:center;gap:6px;font-size:0.8rem;flex:1;touch-action:manipulation;transition:all 0.3s ease;}
        .locate-btn:hover{transform:translateY(-2px);box-shadow:0 5px 10px rgba(67,97,238,0.3);}
        .route-info-panel{background:rgba(13,27,42,0.7);border-radius:10px;padding:15px;border:1px solid #415a77;height:100%;display:flex;flex-direction:column;}
        .route-info-header{color:#778da9;margin-bottom:15px;font-size:1.1rem;text-align:center;padding-bottom:10px;border-bottom:2px solid #415a77;}
        .info-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:10px;flex:1;}
        .info-card{background:rgba(27,58,94,0.5);padding:10px;border-radius:8px;border-left:4px solid #4cc9f0;min-height:60px;transition:transform 0.3s ease;}
        .info-card:hover{transform:translateY(-3px);background:rgba(27,58,94,0.7);}
        .info-card h4{color:#778da9;font-size:0.8rem;margin-bottom:5px;}
        .info-card p{font-size:1rem;font-weight:bold;color:#e0e1dd;}
        .fare-card{background:linear-gradient(135deg,#3a0ca3,#4361ee);border-left-color:#4cc9f0;grid-column:1/-1;text-align:center;padding:15px;border:2px solid #4cc9f0;min-height:90px;animation:pulse 2s infinite;}
        @keyframes pulse{0%{box-shadow:0 0 0 0 rgba(76,201,240,0.4);}70%{box-shadow:0 0 0 10px rgba(76,201,240,0);}100%{box-shadow:0 0 0 0 rgba(76,201,240,0);}}
        .fare-card h4{color:#a0d2ff;font-size:0.9rem;}
        .fare-card p{color:white;font-size:1.4rem;font-weight:bold;margin-top:5px;}
        .fare-details{font-size:0.8rem;margin-top:8px;color:#cce6ff;}
        .app-footer{text-align:center;padding:12px;color:#778da9;font-size:0.7rem;border-top:1px solid #415a77;background:rgba(13,27,42,0.7);border-radius:0 0 15px 15px;}
        .loading-overlay{position:absolute;top:0;left:0;right:0;bottom:0;background:rgba(13,27,42,0.8);display:flex;justify-content:center;align-items:center;z-index:1001;border-radius:12px;flex-direction:column;color:#4cc9f0;font-size:0.95rem;gap:10px;display:none;}
        .loading-spinner{border:4px solid rgba(76,201,240,0.3);border-top:4px solid #4cc9f0;border-radius:50%;width:35px;height:35px;animation:spin 1s linear infinite;}
        @keyframes spin{0%{transform:rotate(0deg);}100%{transform:rotate(360deg);}}
        .error-message{background:rgba(247,37,133,0.2);border:1px solid #f72585;border-radius:8px;padding:8px;margin-top:8px;font-size:0.8rem;display:none;}
        .route-summary{background:rgba(27,58,94,0.7);padding:12px;border-radius:8px;margin-top:10px;font-size:0.85rem;line-height:1.5;border-left:3px solid #4cc9f0;}
        .route-summary h4{margin-bottom:5px;color:#4cc9f0;}
        .gps-status{font-size:0.75rem;margin-top:5px;padding:5px;border-radius:5px;display:flex;align-items:center;gap:5px;}
        .gps-active{background:rgba(76,201,240,0.2);color:#4cc9f0;}
        .gps-error{background:rgba(247,37,133,0.2);color:#f72585;}
        .solution-box{background:rgba(27,58,94,0.7);border-radius:10px;padding:15px;margin:10px 0;border-left:4px solid #f72585;display:flex;flex-direction:column;gap:12px;}
        .solution-box h3{color:#f72585;margin-bottom:10px;display:flex;align-items:center;gap:8px;}
        .solution-steps{padding-left:20px;}
        .solution-steps li{margin-bottom:8px;line-height:1.4;}
        .solution-buttons{display:flex;gap:10px;margin-top:15px;}
        .solution-btn{flex:1;padding:10px;border-radius:8px;border:none;cursor:pointer;font-weight:bold;display:flex;align-items:center;justify-content:center;gap:8px;transition:all 0.3s;}
        .solution-btn.retry{background:linear-gradient(135deg,#4cc9f0,#4361ee);color:white;}
        .solution-btn.manual{background:rgba(255,255,255,0.1);color:#e0e1dd;border:1px solid #415a77;}
        .solution-btn:hover{transform:translateY(-2px);box-shadow:0 5px 10px rgba(0,0,0,0.2);}
        .permission-check{display:flex;align-items:center;gap:8px;margin-top:10px;padding:8px;background:rgba(76,201,240,0.1);border-radius:8px;font-size:0.8rem;}
        .permission-check input{width:16px;height:16px;}
        @media (max-width:480px){.input-panel{padding:12px;}.location-buttons{flex-direction:column;}.locate-btn{width:100%;}.info-grid{grid-template-columns:1fr;}.fare-card p{font-size:1.3rem;}.map-overlay{font-size:0.75rem;padding:6px 10px;}.action-panel{flex-direction:column;}#clear-route-btn{max-width:100%;}.app-info{margin-top:15px;}.solution-buttons{flex-direction:column;}}
        @media (min-width:768px){.main-content{grid-template-columns:1fr 1.2fr;}.map-panel{height:100%;}}
        .leaflet-container{background:#1b263b;}
    </style>
</head>
<body>
    <div class="container">
        <div class="solution-box" id="solution-box">
            <h3><i class="fas fa-exclamation-triangle"></i> Giải quyết lỗi truy cập vị trí</h3>
            <p>Bạn đã từ chối quyền truy cập vị trí. Để sử dụng tính năng này:</p>
            <div class="solution-steps">
                <li><strong>Trên trình duyệt:</strong> Nhấn vào biểu tượng ổ khóa > "Cài đặt trang" > "Quyền" > Chọn "Cho phép" ở mục Vị trí</li>
                <li><strong>Trên thiết bị Android:</strong> Vào Cài đặt > Ứng dụng > [Tên trình duyệt] > Quyền > Bật "Vị trí"</li>
                <li><strong>Trên thiết bị iOS:</strong> Vào Cài đặt > Quyền riêng tư > Dịch vụ định vị > Bật cho trình duyệt</li>
            </div>
            <div class="permission-check">
                <input type="checkbox" id="permission-checkbox">
                <label for="permission-checkbox">Tôi đã bật quyền truy cập vị trí và muốn thử lại</label>
            </div>
            <div class="solution-buttons">
                <button class="solution-btn retry" id="retry-geolocation"><i class="fas fa-redo"></i> Thử lại</button>
                <button class="solution-btn manual" id="manual-input"><i class="fas fa-keyboard"></i> Nhập thủ công</button>
            </div>
        </div>
        
        <div class="main-content">
            <div class="map-panel">
                <div id="map-container">
                    <div class="loading-overlay" id="loading-overlay">
                        <div class="loading-spinner"></div>
                        <p>Đang tính toán tuyến đường...</p>
                    </div>
                    <div class="map-overlay"><i class="fas fa-map-marked-alt"></i> Bản đồ đang tải...</div>
                </div>
                <div class="action-panel">
                    <button id="find-route-btn" class="action-btn"><i class="fas fa-route"></i> Tìm Đường & Tính Cước</button>
                    <button id="clear-route-btn" class="action-btn"><i class="fas fa-trash-alt"></i> Xóa Tuyến</button>
                </div>
            </div>
            
            <div class="input-section">
                <div class="input-panel">
                    <h2><i class="fas fa-map-marker-alt"></i> Điểm xuất phát</h2>
                    <div class="input-group">
                        <i class="fas fa-search input-icon"></i>
                        <input type="text" id="start-input" placeholder="Nhập địa điểm xuất phát...">
                        <ul id="start-suggestions" class="suggestions-list"></ul>
                    </div>
                    <div class="location-buttons">
                        <button class="locate-btn" id="locate-start"><i class="fas fa-location-arrow"></i> Xác định vị trí hiện tại</button>
                    </div>
                    <p id="start-selected-text" class="selected-location">
                        <i class="fas fa-info-circle"></i> Điểm xuất phát đã chọn: <span class="location-text">Chưa chọn</span>
                        <button class="clear-btn" data-for="start-input"><i class="fas fa-times"></i></button>
                    </p>
                    <div id="start-error" class="error-message"></div>
                    <div id="start-gps-status" class="gps-status"><i class="fas fa-satellite"></i> Trạng thái GPS: <span id="start-gps-text">Chưa kích hoạt</span></div>
                </div>
                
                <div class="input-panel">
                    <h2><i class="fas fa-flag-checkered"></i> Điểm đến</h2>
                    <div class="input-group">
                        <i class="fas fa-search input-icon"></i>
                        <input type="text" id="end-input" placeholder="Nhập địa điểm đến...">
                        <ul id="end-suggestions" class="suggestions-list"></ul>
                    </div>
                    <div class="location-buttons">
                        <button class="locate-btn" id="locate-end"><i class="fas fa-location-arrow"></i> Xác định vị trí hiện tại</button>
                    </div>
                    <p id="end-selected-text" class="selected-location">
                        <i class="fas fa-info-circle"></i> Điểm đến đã chọn: <span class="location-text">Chưa chọn</span>
                        <button class="clear-btn" data-for="end-input"><i class="fas fa-times"></i></button>
                    </p>
                    <div id="end-error" class="error-message"></div>
                    <div id="end-gps-status" class="gps-status"><i class="fas fa-satellite"></i> Trạng thái GPS: <span id="end-gps-text">Chưa kích hoạt</span></div>
                </div>
                
                <div class="route-info-panel">
                    <h3 class="route-info-header">Thông Tin Tuyến Đường</h3>
                    <div class="info-grid">
                        <div class="info-card"><h4>Điểm xuất phát</h4><p id="start-info">-</p></div>
                        <div class="info-card"><h4>Điểm đến</h4><p id="end-info">-</p></div>
                        <div class="info-card"><h4>Khoảng cách</h4><p id="distance-info">-</p></div>
                        <div class="info-card"><h4>Thời gian di chuyển</h4><p id="duration-info">-</p></div>
                        <div class="fare-card">
                            <h4>CƯỚC PHÍ ƯỚC TÍNH</h4>
                            <p id="fare-info">-</p>
                            <p class="fare-details" id="fare-details"></p>
                        </div>
                        <div class="route-summary">
                            <h4><i class="fas fa-clipboard-list"></i> Tóm tắt cước phí</h4>
                            <div id="fare-breakdown"></div>
                        </div>
                    </div>
                </div>
                
                <div class="app-info" id="app-info">
                    <div class="app-info-header">
                        <h3><i class="fas fa-info-circle"></i> Hướng dẫn sử dụng</h3>
                        <i class="fas fa-chevron-down" id="toggle-info"></i>
                    </div>
                    <div class="app-info-content">
                        <p>1. Nhập điểm xuất phát và điểm đến<br>2. Sử dụng nút "Xác định vị trí" để tự động điền vị trí hiện tại<br>3. Nhấn nút "Tìm Đường & Tính Cước" để xem kết quả<br>4. Sử dụng "Xóa Tuyến" để bắt đầu lại</p>
                        <p style="margin-top:10px;color:#f72585;"><i class="fas fa-exclamation-circle"></i> Lưu ý: Trên thiết bị di động, vui lòng bật GPS và cấp quyền vị trí cho trình duyệt.</p>
                        <p style="margin-top:5px;color:#4cc9f0;"><i class="fas fa-lightbulb"></i> Mẹo: Nếu gặp lỗi vị trí, hãy kiểm tra cài đặt quyền của trình duyệt</p>
                    </div>
                </div>
            </div>
        </div>
        
        <footer class="app-footer">
            <p>Ứng dụng Tìm Đường & Tính Cước &copy; 2023 - Sử dụng công nghệ Leaflet & OSRM</p>
            <p>Đã tối ưu cho thiết bị di động Android và iOS</p>
        </footer>
    </div>

    <script>
        // Tối ưu hóa code JavaScript
        window.addEventListener('load', function() {
            let map, startMarker, endMarker, routeLayer, gpsWatchId = null;
            const defaultCenter = [21.0285, 105.8542];
            const defaultZoom = 13;
            let geolocationDenied = false;
            const isIOS = () => /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;
            
            // Function to toggle the visibility of the solution box for geolocation errors
            function toggleSolutionBox(show) {
                document.getElementById('solution-box').style.display = show ? 'block' : 'none';
            }
            
            // Initialize the Leaflet map
            function initMap() {
                map = L.map('map-container', {
                    preferCanvas: true,
                    zoomControl: true,
                    tap: false
                }).setView(defaultCenter, defaultZoom);
                
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
                    maxZoom: 19
                }).addTo(map);
                
                document.querySelector('.map-overlay').style.display = 'none'; // Hide map loading overlay
                setTimeout(() => {
                    map.invalidateSize(); // Invalidate map size to ensure it renders correctly
                    map.setView(defaultCenter, defaultZoom); // Set initial view
                }, 100);
            }
            
            initMap(); // Call map initialization
            
            // Debounce function to limit the rate of function calls
            function debounce(func, delay) {
                let timeout;
                return function(...args) {
                    const context = this;
                    clearTimeout(timeout);
                    timeout = setTimeout(() => func.apply(context, args), delay);
                };
            }

            // Show suggestions list for location input
            function showSuggestions(suggestionListId) {
                document.getElementById(suggestionListId).style.display = 'block';
            }
            
            // Hide suggestions list for location input
            function hideSuggestions(suggestionListId) {
                document.getElementById(suggestionListId).style.display = 'none';
            }

            // Get current geolocation of the user
            function getCurrentLocation(inputId) {
                const inputField = document.getElementById(inputId);
                const errorElement = document.getElementById(inputId.replace('-input', '-error'));
                const gpsStatusElement = document.getElementById(inputId.replace('-input', '-gps-status'));
                const gpsTextElement = document.getElementById(inputId.replace('-input', '-gps-text'));
                
                // Check if geolocation is supported by the browser
                if (!navigator.geolocation) {
                    errorElement.textContent = "Trình duyệt của bạn không hỗ trợ xác định vị trí";
                    errorElement.style.display = 'block';
                    gpsStatusElement.className = 'gps-status gps-error';
                    gpsTextElement.textContent = 'Không hỗ trợ';
                    return;
                }
                
                // Update GPS status display
                gpsStatusElement.className = 'gps-status gps-active';
                gpsTextElement.textContent = 'Đang định vị...';
                
                // Get current position using geolocation API
                navigator.geolocation.getCurrentPosition(
                    async (position) => {
                        const lat = position.coords.latitude;
                        const lng = position.coords.longitude;
                        
                        toggleSolutionBox(false); // Hide solution box if geolocation is successful
                        geolocationDenied = false;
                        
                        try {
                            // Reverse geocode coordinates to get a human-readable address
                            const response = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}&zoom=18&addressdetails=1`);
                            const data = await response.json();
                            
                            if (data.display_name) {
                                inputField.value = data.display_name;
                                const targetIdForSelectedText = inputId.replace('-input', '-selected-text');
                                const selectedText = document.getElementById(targetIdForSelectedText);
                                selectedText.querySelector('.location-text').textContent = data.display_name;
                                
                                inputField.dataset.lat = lat;
                                inputField.dataset.lng = lng;
                                inputField.dataset.displayName = data.display_name;
                                
                                updateMapMarker(inputField.id, [parseFloat(lat), parseFloat(lng)]);
                                
                                errorElement.style.display = 'none'; // Hide any previous error messages
                                
                                gpsStatusElement.className = 'gps-status gps-active';
                                gpsTextElement.textContent = 'Đã định vị thành công';
                                
                                startTrackingLocation(inputId); // Start tracking location after successful initial fix
                            } else {
                                throw new Error("Không tìm thấy tên địa điểm");
                            }
                        } catch (error) {
                            console.error("Lỗi khi lấy địa chỉ:", error);
                            gpsStatusElement.className = 'gps-status gps-error';
                            gpsTextElement.textContent = 'Lỗi: Không thể xác định địa chỉ';
                        }
                    },
                    (error) => {
                        console.error("Lỗi khi lấy vị trí:", error); // Log the full error object
                        
                        let errorMessage;
                        switch(error.code) {
                            case error.PERMISSION_DENIED:
                                errorMessage = "Bạn đã từ chối quyền truy cập vị trí.";
                                geolocationDenied = true;
                                toggleSolutionBox(true); // Show solution box if permission is denied
                                break;
                            case error.POSITION_UNAVAILABLE:
                                errorMessage = "Thông tin vị trí hiện không khả dụng.";
                                break;
                            case error.TIMEOUT:
                                errorMessage = "Yêu cầu vị trí đã hết thời gian chờ. Vui lòng thử lại.";
                                break;
                            default:
                                // Fallback message if error.code is not specific or undefined
                                errorMessage = "Đã xảy ra lỗi không xác định khi lấy vị trí: " + (error.message || 'Không xác định');
                        }
                        
                        errorElement.textContent = errorMessage;
                        errorElement.style.display = 'block';
                        gpsStatusElement.className = 'gps-status gps-error';
                        // Use the errorMessage for display, providing a fallback if error.code is undefined
                        gpsTextElement.textContent = 'Lỗi: ' + (error.code || 'Không xác định');
                    },
                    {
                        enableHighAccuracy: true,
                        timeout: isIOS() ? 15000 : 10000,
                        maximumAge: 0
                    }
                );
            }
            
            // Start continuously tracking the user's location
            function startTrackingLocation(inputId) {
                if (gpsWatchId) navigator.geolocation.clearWatch(gpsWatchId); // Clear any existing watch
                
                const gpsStatusElement = document.getElementById(inputId.replace('-input', '-gps-status'));
                const gpsTextElement = document.getElementById(inputId.replace('-input', '-gps-text'));
                
                gpsWatchId = navigator.geolocation.watchPosition(
                    (position) => {
                        const lat = position.coords.latitude;
                        const lng = position.coords.longitude;
                        updateMapMarker(inputId, [parseFloat(lat), parseFloat(lng)]); // Update marker on map
                        gpsStatusElement.className = 'gps-status gps-active';
                        gpsTextElement.textContent = 'Đang cập nhật vị trí';
                        // Briefly show "Đang cập nhật vị trí" then switch to "Đang theo dõi vị trí"
                        setTimeout(() => gpsTextElement.textContent = 'Đang theo dõi vị trí', 2000);
                    },
                    (error) => {
                        console.error("Lỗi khi theo dõi vị trí:", error); // Log the full error object
                        let errorMessage;
                        switch(error.code) {
                            case error.PERMISSION_DENIED:
                                errorMessage = 'Bạn đã từ chối quyền truy cập vị trí';
                                geolocationDenied = true;
                                toggleSolutionBox(true);
                                break;
                            case error.POSITION_UNAVAILABLE:
                                errorMessage = 'Thông tin vị trí không khả dụng';
                                break;
                            case error.TIMEOUT:
                                errorMessage = 'Hết thời gian chờ lấy vị trí';
                                break;
                            default:
                                // Fallback message if error.message is not specific or undefined
                                errorMessage = 'Lỗi: ' + (error.message || 'Không xác định');
                        }
                        gpsStatusElement.className = 'gps-status gps-error';
                        gpsTextElement.textContent = errorMessage;
                    },
                    {
                        enableHighAccuracy: true,
                        timeout: isIOS() ? 15000 : 10000,
                        maximumAge: 0
                    }
                );
            }
            
            // Stop tracking the user's location
            function stopTracking() {
                if (gpsWatchId) {
                    navigator.geolocation.clearWatch(gpsWatchId);
                    gpsWatchId = null;
                }
                // Reset GPS status for both input fields
                document.getElementById('start-gps-status').className = 'gps-status';
                document.getElementById('start-gps-text').textContent = 'Chưa kích hoạt';
                document.getElementById('end-gps-status').className = 'gps-status';
                document.getElementById('end-gps-text').textContent = 'Chưa kích hoạt';
            }

            // Render location suggestions in the list
            function renderSuggestions(locations, suggestionListId) {
                const suggestionsList = document.getElementById(suggestionListId);
                suggestionsList.innerHTML = '';
                
                if (locations.length === 0) {
                    suggestionsList.innerHTML = '<li><i class="fas fa-exclamation-circle"></i> Không tìm thấy kết quả phù hợp</li>';
                    return;
                }
                
                locations.forEach(location => {
                    const li = document.createElement('li');
                    const address = location.address || {};
                    let displayName = location.display_name || '';
                    const houseNumber = address.house_number || '';
                    const road = address.road || '';
                    const suburb = address.suburb || address.neighbourhood || '';
                    const city = address.city || address.town || address.village || '';
                    
                    let shortAddress = displayName;
                    // Construct a shorter, more readable address if possible
                    if (houseNumber && road) {
                        shortAddress = `${houseNumber} ${road}`;
                        if (suburb) shortAddress += `, ${suburb}`;
                        if (city) shortAddress += `, ${city}`;
                    }
                    
                    li.innerHTML = `
                        <div>
                            <i class="fas fa-map-marker-alt"></i> 
                            <div>
                                <strong>${shortAddress}</strong>
                                <div class="address-details">${displayName}</div>
                            </div>
                        </div>
                    `;
                    li.dataset.lat = location.lat;
                    li.dataset.lng = location.lon;
                    li.dataset.displayName = displayName;
                    
                    // Event listener for when a suggestion is clicked
                    li.addEventListener('click', () => {
                        const inputField = document.getElementById(suggestionListId.replace('-suggestions', '-input'));
                        const targetIdForSelectedText = suggestionListId.replace('-suggestions', '-selected-text');
                        const selectedText = document.getElementById(targetIdForSelectedText);
                        
                        inputField.value = shortAddress;
                        selectedText.querySelector('.location-text').textContent = shortAddress;
                        
                        inputField.dataset.lat = location.lat;
                        inputField.dataset.lng = location.lon;
                        inputField.dataset.displayName = displayName;
                        
                        hideSuggestions(suggestionListId); // Hide suggestions after selection
                        updateMapMarker(inputField.id, [parseFloat(location.lat), parseFloat(location.lon)]);
                        stopTracking(); // Stop GPS tracking if a manual location is selected
                    });
                    
                    suggestionsList.appendChild(li);
                });
            }

            // Fetch location suggestions from Nominatim API
            async function fetchSuggestions(query, suggestionListId) {
                const suggestionsList = document.getElementById(suggestionListId);
                if (query.length < 2) {
                    hideSuggestions(suggestionListId);
                    return;
                }
                
                showSuggestions(suggestionListId);
                suggestionsList.innerHTML = '<li><i class="fas fa-spinner fa-spin"></i> Đang tìm kiếm địa điểm...</li>';
                
                try {
                    const response = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}&limit=5&addressdetails=1&countrycodes=vn`);
                    const data = await response.json();
                    renderSuggestions(data, suggestionListId);
                } catch (error) {
                    console.error('Error fetching suggestions:', error);
                    suggestionsList.innerHTML = '<li><i class="fas fa-exclamation-triangle"></i> Lỗi khi tải dữ liệu</li>';
                }
            }

            // Update map markers for start and end points
            function updateMapMarker(inputId, coords) {
                const locationType = inputId.includes('start') ? 'start' : 'end';
                
                if (locationType === 'start' && startMarker) map.removeLayer(startMarker);
                else if (endMarker) map.removeLayer(endMarker);
                
                const marker = L.marker(coords).addTo(map);
                marker.bindPopup(locationType === 'start' ? 'Điểm xuất phát' : 'Điểm đến').openPopup();
                
                // Custom marker icon for start and end points
                marker.setIcon(
                    L.divIcon({
                        className: locationType + '-marker',
                        html: `<div style="background-color:${locationType==='start'?'#4cc9f0':'#f72585'};width:30px;height:30px;border-radius:50%;display:flex;align-items:center;justify-content:center;transform:translate(-15px,-15px);">
                                <i class="fas ${locationType==='start'?'fa-flag':'fa-flag-checkered'}" style="color:white;font-size:14px;"></i>
                             </div>`
                    })
                );
                
                if (locationType === 'start') startMarker = marker;
                else endMarker = marker;
                
                // Adjust map view to fit both markers if both are present
                if (startMarker && endMarker) {
                    const bounds = L.latLngBounds(
                        [startMarker.getLatLng().lat, startMarker.getLatLng().lng],
                        [endMarker.getLatLng().lat, endMarker.getLatLng().lng]
                    );
                    map.fitBounds(bounds, { padding: [50, 50] });
                } else {
                    map.setView(coords, 15); // Zoom to the single marker
                }
                setTimeout(() => map.invalidateSize(), 100); // Ensure map renders correctly after changes
            }

            // Get route and calculate distance/duration using OSRM API
            async function getRoute(startCoords, endCoords) {
                try {
                    document.getElementById('loading-overlay').style.display = 'flex'; // Show loading overlay
                    const response = await fetch(`https://router.project-osrm.org/route/v1/driving/${startCoords[1]},${startCoords[0]};${endCoords[1]},${endCoords[0]}?overview=full&geometries=geojson`);
                    const data = await response.json();
                    
                    if (data.code !== 'Ok') throw new Error("Không tìm thấy tuyến đường");
                    
                    const route = data.routes[0];
                    const distanceKm = (route.distance / 1000).toFixed(1);
                    const durationMinutes = Math.round(route.duration / 60);
                    
                    drawRoute(route.geometry.coordinates); // Draw the route on the map
                    document.getElementById('loading-overlay').style.display = 'none'; // Hide loading overlay
                    return { distance: distanceKm, duration: durationMinutes };
                } catch (error) {
                    document.getElementById('loading-overlay').style.display = 'none'; // Hide loading overlay on error
                    console.error('Lỗi khi lấy tuyến đường:', error);
                    throw error;
                }
            }

            // Draw the route polyline on the map
            function drawRoute(coordinates) {
                if (routeLayer) map.removeLayer(routeLayer); // Remove existing route if any
                const latLngs = coordinates.map(coord => [coord[1], coord[0]]);
                
                routeLayer = L.polyline(latLngs, {
                    color: '#4285F4', // Blue color for the route
                    weight: 6,
                    opacity: 0.9,
                    lineCap: 'round',
                    lineJoin: 'round'
                }).addTo(map);
                
                map.fitBounds(routeLayer.getBounds(), { padding: [50, 50] }); // Fit map to the route
                setTimeout(() => map.invalidateSize(), 100);
            }

            // Calculate estimated fare based on distance
            function calculate_fare(distance) {
                let baseFare, perKm = 10000, totalFare;
                distance = parseFloat(distance);
                
                // Define base fares based on distance ranges
                if (distance <= 10) baseFare = 199000;
                else if (distance <= 20) baseFare = 189000;
                else if (distance <= 30) baseFare = 179000;
                else if (distance <= 40) baseFare = 169000;
                else if (distance <= 50) baseFare = 159000;
                else return {
                    fare: "Khoảng cách quá xa",
                    details: "Chỉ hỗ trợ tuyến đường dưới 50km",
                    breakdown: ""
                };
                
                totalFare = baseFare + perKm * distance;
                // Generate detailed fare breakdown HTML
                const breakdown = `
                    <div>Giá khởi điểm: ${new Intl.NumberFormat('vi-VN').format(baseFare)} VNĐ</div>
                    <div>Phí theo km (${distance} km × ${perKm.toLocaleString('vi-VN')} VNĐ/km): ${new Intl.NumberFormat('vi-VN').format(perKm * distance)} VNĐ</div>
                    <div style="margin-top:5px;border-top:1px solid #4cc9f0;padding-top:5px;font-weight:bold;">
                        Tổng cước phí: ${new Intl.NumberFormat('vi-VN').format(totalFare)} VNĐ
                    </div>
                `;
                
                return {
                    fare: new Intl.NumberFormat('vi-VN').format(totalFare) + " VNĐ",
                    details: `Giá khởi điểm: ${new Intl.NumberFormat('vi-VN').format(baseFare)} VNĐ + ${perKm.toLocaleString('vi-VN')} VNĐ/km`,
                    breakdown: breakdown
                };
            }

            // Clear all route information and reset map
            function clearRoute() {
                if (startMarker) map.removeLayer(startMarker);
                if (endMarker) map.removeLayer(endMarker);
                if (routeLayer) map.removeLayer(routeLayer);
                
                startMarker = null;
                endMarker = null;
                routeLayer = null;
                
                const startInput = document.getElementById('start-input');
                const endInput = document.getElementById('end-input');
                startInput.value = '';
                endInput.value = '';
                startInput.removeAttribute('data-lat');
                startInput.removeAttribute('data-lng');
                startInput.removeAttribute('data-display-name');
                endInput.removeAttribute('data-lat');
                endInput.removeAttribute('data-lng');
                endInput.removeAttribute('data-display-name');
                
                document.querySelectorAll('.location-text').forEach(el => el.textContent = 'Chưa chọn');
                document.getElementById('start-info').textContent = '-';
                document.getElementById('end-info').textContent = '-';
                document.getElementById('distance-info').textContent = '-';
                document.getElementById('duration-info').textContent = '-';
                document.getElementById('fare-info').textContent = '-';
                document.getElementById('fare-details').textContent = '';
                document.getElementById('fare-breakdown').innerHTML = '';
                
                map.setView(defaultCenter, defaultZoom); // Reset map view to default
                stopTracking(); // Stop any active GPS tracking
                toggleSolutionBox(false); // Hide solution box
            }

            // Event Listeners
            const startInput = document.getElementById('start-input');
            const endInput = document.getElementById('end-input');
            
            // Debounced input event listeners for fetching suggestions
            const debouncedFetchStartSuggestions = debounce(e => fetchSuggestions(e.target.value, 'start-suggestions'), 300);
            const debouncedFetchEndSuggestions = debounce(e => fetchSuggestions(e.target.value, 'end-suggestions'), 300);
            
            startInput.addEventListener('input', debouncedFetchStartSuggestions);
            endInput.addEventListener('input', debouncedFetchEndSuggestions);
            
            // Show suggestions on input focus
            startInput.addEventListener('focus', () => showSuggestions('start-suggestions'));
            endInput.addEventListener('focus', () => showSuggestions('end-suggestions'));
            
            // Hide suggestions when clicking outside
            document.addEventListener('click', (e) => {
                if (!e.target.closest('#start-suggestions') && e.target !== startInput) hideSuggestions('start-suggestions');
                if (!e.target.closest('#end-suggestions') && e.target !== endInput) hideSuggestions('end-suggestions');
            });
            
            // Event listeners for "Locate current position" buttons
            document.getElementById('locate-start').addEventListener('click', () => getCurrentLocation('start-input'));
            document.getElementById('locate-end').addEventListener('click', () => getCurrentLocation('end-input'));

            // Event listener for "Retry Geolocation" button in the solution box
            document.getElementById('retry-geolocation').addEventListener('click', () => {
                if (document.getElementById('permission-checkbox').checked) getCurrentLocation('start-input');
                else alert("Vui lòng xác nhận bạn đã bật quyền truy cập vị trí");
            });

            // Event listener for "Manual Input" button in the solution box
            document.getElementById('manual-input').addEventListener('click', () => {
                toggleSolutionBox(false);
                document.getElementById('start-input').focus(); // Focus on start input for manual entry
            });
            
            // Event listeners for clear buttons next to selected locations
            document.querySelectorAll('.clear-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const inputId = this.dataset.for;
                    const inputField = document.getElementById(inputId);
                    const selectedText = this.parentElement.querySelector('.location-text');
                    
                    inputField.value = '';
                    inputField.removeAttribute('data-lat');
                    inputField.removeAttribute('data-lng');
                    inputField.removeAttribute('data-display-name');
                    selectedText.textContent = 'Chưa chọn';
                    
                    // Remove corresponding marker from map
                    if (inputId === 'start-input' && startMarker) {
                        map.removeLayer(startMarker);
                        startMarker = null;
                    } else if (inputId === 'end-input' && endMarker) {
                        map.removeLayer(endMarker);
                        endMarker = null;
                    }
                    
                    // Reset map view if both markers are cleared
                    if (!startMarker && !endMarker) map.setView(defaultCenter, defaultZoom);
                    stopTracking(); // Stop GPS tracking if a location is cleared
                });
            });
            
            // Event listener for "Find Route & Calculate Fare" button
            document.getElementById('find-route-btn').addEventListener('click', async () => {
                const startInput = document.getElementById('start-input');
                const endInput = document.getElementById('end-input');
                
                if (!startInput.dataset.displayName || !endInput.dataset.displayName) {
                    alert("Vui lòng chọn cả điểm xuất phát và điểm đến");
                    return;
                }
                
                const startCoords = [parseFloat(startInput.dataset.lat), parseFloat(startInput.dataset.lng)];
                const endCoords = [parseFloat(endInput.dataset.lat), parseFloat(endInput.dataset.lng)];
                
                try {
                    const { distance, duration } = await getRoute(startCoords, endCoords);
                    const fareResult = calculate_fare(distance);
                    
                    // Update route information display
                    document.getElementById('start-info').textContent = startInput.dataset.displayName;
                    document.getElementById('end-info').textContent = endInput.dataset.displayName;
                    document.getElementById('distance-info').textContent = distance + " km";
                    document.getElementById('duration-info').textContent = `${duration} phút`;
                    document.getElementById('fare-info').textContent = fareResult.fare;
                    document.getElementById('fare-details').textContent = fareResult.details;
                    document.getElementById('fare-breakdown').innerHTML = fareResult.breakdown;
                } catch (error) {
                    alert("Đã xảy ra lỗi khi tính toán tuyến đường. Vui lòng thử lại.");
                }
            });
            
            document.getElementById('clear-route-btn').addEventListener('click', clearRoute);

            // Event listener for toggling app info/instructions
            document.getElementById('toggle-info').addEventListener('click', function() {
                document.getElementById('app-info').classList.toggle('expanded');
                this.classList.toggle('fa-chevron-down');
                this.classList.toggle('fa-chevron-up');
            });
            
            // Adjust map size on window resize
            window.addEventListener('resize', function() {
                if (map) setTimeout(() => map.invalidateSize(), 100);
            });
            
            // Check and handle geolocation permissions
            if (!navigator.permissions) {
                document.getElementById('start-gps-status').className = 'gps-status gps-error';
                document.getElementById('start-gps-text').textContent = 'Không hỗ trợ API Quyền';
                document.getElementById('end-gps-status').className = 'gps-status gps-error';
                document.getElementById('end-gps-text').textContent = 'Không hỗ trợ API Quyền';
            } else {
                navigator.permissions.query({name: 'geolocation'}).then(permissionStatus => {
                    permissionStatus.onchange = () => {
                        if (permissionStatus.state === 'granted') {
                            toggleSolutionBox(false);
                            geolocationDenied = false;
                        } else if (permissionStatus.state === 'denied') {
                            geolocationDenied = true;
                            toggleSolutionBox(true);
                        }
                    };
                });
            }
            
            // Demo locations for initial load
            setTimeout(() => {
                document.getElementById('start-input').value = "Hồ Hoàn Kiếm, Hà Nội";
                document.getElementById('start-input').dataset.lat = "21.028511";
                document.getElementById('start-input').dataset.lng = "105.852188";
                document.getElementById('start-input').dataset.displayName = "Hồ Hoàn Kiếm, Hà Nội";
                document.getElementById('start-selected-text').querySelector('.location-text').textContent = "Hồ Hoàn Kiếm, Hà Nội";
                
                document.getElementById('end-input').value = "Văn Miếu, Hà Nội";
                document.getElementById('end-input').dataset.lat = "21.027444";
                document.getElementById('end-input').dataset.lng = "105.835444";
                document.getElementById('end-input').dataset.displayName = "Văn Miếu, Hà Nội";
                document.getElementById('end-selected-text').querySelector('.location-text').textContent = "Văn Miếu, Hà Nội";
                
                updateMapMarker('start-input', [21.028511, 105.852188]);
                updateMapMarker('end-input', [21.027444, 105.835444]);
            }, 1000);
        });
    </script>
</body>
</html>
